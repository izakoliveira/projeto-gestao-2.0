<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Predecessoras</title>
    <style>
        .calculada {
            background-color: #fffbe6 !important;
        }
        .readonly {
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body>
    <h1>Teste de Valida√ß√£o de Predecessoras</h1>
    
    <table id="tabela-tarefas-inline">
        <thead>
            <tr>
                <th>Ordem</th>
                <th>Nome</th>
                <th>Predecessoras</th>
                <th>Data In√≠cio</th>
                <th>Data Fim</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="numero-tarefa">1</td>
                <td>Tarefa 1</td>
                <td>
                    <input type="text" name="predecessoras" value="" placeholder="Ex: 2FS+2d">
                </td>
                <td>
                    <input type="date" name="data_inicio" value="2024-01-01">
                </td>
                <td>
                    <input type="date" name="data_fim" value="2024-01-05">
                </td>
            </tr>
            <tr>
                <td class="numero-tarefa">2</td>
                <td>Tarefa 2</td>
                <td>
                    <input type="text" name="predecessoras" value="1FS" placeholder="Ex: 2FS+2d">
                </td>
                <td>
                    <input type="date" name="data_inicio" value="">
                </td>
                <td>
                    <input type="date" name="data_fim" value="">
                </td>
            </tr>
            <tr>
                <td class="numero-tarefa">3</td>
                <td>Tarefa 3</td>
                <td>
                    <input type="text" name="predecessoras" value="2SS+1d" placeholder="Ex: 2FS+2d">
                </td>
                <td>
                    <input type="date" name="data_inicio" value="">
                </td>
                <td>
                    <input type="date" name="data_fim" value="">
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        function onPredecessorasEdit(input) {
            console.log('üîß onPredecessorasEdit chamada para:', input.value);
            const tr = input.closest('tr');
            const predecessorasStr = input.value.trim();
            const dataInicioInput = tr.querySelector('input[name="data_inicio"]');
            const dataFimInput = tr.querySelector('input[name="data_fim"]');
            
            console.log('üìÖ Campos encontrados:', {
                dataInicioInput: !!dataInicioInput,
                dataFimInput: !!dataFimInput,
                predecessorasStr: predecessorasStr
            });
            
            // Se n√£o h√° predecessoras, liberar edi√ß√£o manual
            if (!predecessorasStr) {
                console.log('‚ùå Sem predecessoras, liberando edi√ß√£o manual');
                if (dataInicioInput) {
                    dataInicioInput.readOnly = false;
                    dataInicioInput.dataset.calculada = '';
                    dataInicioInput.style.background = '';
                }
                if (dataFimInput) {
                    dataFimInput.readOnly = false;
                    dataFimInput.dataset.calculada = '';
                    dataFimInput.style.background = '';
                }
                return;
            }
            
            const preds = predecessorasStr.split(';').map(s => s.trim()).filter(Boolean);
            console.log('üîó Predecessoras processadas:', preds);
            
            if (preds.length === 0) return;
            
            // Mapear n√∫mero de ordem para linha da tabela
            const linhas = Array.from(document.querySelectorAll('#tabela-tarefas-inline tbody tr')).filter(tr => tr.id !== 'linha-nova-tarefa');
            const ordemParaLinha = {};
            linhas.forEach(trLinha => {
                const ordem = trLinha.querySelector('.numero-tarefa')?.textContent?.trim();
                if (ordem) ordemParaLinha[ordem] = trLinha;
            });
            
            console.log('üìä Ordem para linha mapeada:', ordemParaLinha);
            
            // Para cada predecessora, calcular a data alvo
            let datasInicio = [];
            let datasFim = [];
            preds.forEach(pred => {
                // Ex: 2FS+2d, 3SS-1d
                const m = pred.match(/^(\d+)(FS|SS|FF|SF)?([+-]\d+d)?$/);
                if (!m) {
                    console.log(`‚ö†Ô∏è Predecessora inv√°lida: ${pred}`);
                    return;
                }
                const ordemPred = m[1];
                const tipo = m[2] || 'FS';
                const desloc = m[3] || '';
                const linhaPred = ordemParaLinha[ordemPred];
                
                console.log(`üîç Processando predecessora: ${pred} (ordem: ${ordemPred}, tipo: ${tipo}, desloc: ${desloc})`);
                
                if (!linhaPred) {
                    console.log(`‚ùå Linha predecessora n√£o encontrada para ordem: ${ordemPred}`);
                    return;
                }
                
                const dataInicioPred = linhaPred.querySelector('input[name="data_inicio"]').value;
                const dataFimPred = linhaPred.querySelector('input[name="data_fim"]').value;
                
                console.log(`üìÖ Datas da predecessora: in√≠cio=${dataInicioPred}, fim=${dataFimPred}`);
                
                let baseDate = null;
                if (tipo === 'FS') baseDate = dataFimPred;
                else if (tipo === 'SS') baseDate = dataInicioPred;
                else if (tipo === 'FF') baseDate = dataFimPred;
                else if (tipo === 'SF') baseDate = dataInicioPred;
                
                if (!baseDate) {
                    console.log(`‚ùå Data base n√£o encontrada para tipo: ${tipo}`);
                    return;
                }
                
                let data = new Date(baseDate);
                if (desloc) {
                    const matchDesloc = desloc.match(/([+-])(\d+)d/);
                    if (matchDesloc) {
                        const sinal = matchDesloc[1] === '+' ? 1 : -1;
                        const dias = parseInt(matchDesloc[2], 10);
                        data.setDate(data.getDate() + sinal * dias);
                        console.log(`üìÖ Data ajustada: ${data.toISOString().split('T')[0]} (${sinal * dias} dias)`);
                    }
                }
                
                if (tipo === 'FS' || tipo === 'SS') datasInicio.push(data);
                else if (tipo === 'FF' || tipo === 'SF') datasFim.push(data);
            });
            
            console.log('üìä Datas calculadas:', { datasInicio: datasInicio.length, datasFim: datasFim.length });
            
            // Para m√∫ltiplas predecessoras: para datas de in√≠cio, usar a MAIOR; para datas de fim, usar a MAIOR
            let dataInicioFinal = null;
            let dataFimFinal = null;
            datasInicio.forEach(d => { if (!dataInicioFinal || d > dataInicioFinal) dataInicioFinal = d; });
            datasFim.forEach(d => { if (!dataFimFinal || d > dataFimFinal) dataFimFinal = d; });
            
            console.log('üéØ Datas finais:', {
                dataInicioFinal: dataInicioFinal ? dataInicioFinal.toISOString().split('T')[0] : null,
                dataFimFinal: dataFimFinal ? dataFimFinal.toISOString().split('T')[0] : null
            });
            
            // Preencher e bloquear os campos conforme o tipo
            if (dataInicioFinal && dataInicioInput) {
                dataInicioInput.value = dataInicioFinal.toISOString().split('T')[0];
                dataInicioInput.dataset.calculada = '1';
                dataInicioInput.readOnly = true;
                dataInicioInput.style.background = '#fffbe6';
                console.log('‚úÖ Data de in√≠cio calculada e bloqueada');
            }
            if (dataFimFinal && dataFimInput) {
                dataFimInput.value = dataFimFinal.toISOString().split('T')[0];
                dataFimInput.dataset.calculada = '1';
                dataFimInput.readOnly = true;
                dataFimInput.style.background = '#fffbe6';
                console.log('‚úÖ Data de fim calculada e bloqueada');
            }
            
            // Se n√£o houver predecessora para um dos campos, liberar edi√ß√£o
            if (!dataInicioFinal && dataInicioInput) {
                dataInicioInput.readOnly = false;
                dataInicioInput.dataset.calculada = '';
                dataInicioInput.style.background = '';
                console.log('üîì Data de in√≠cio liberada para edi√ß√£o');
            }
            if (!dataFimFinal && dataFimInput) {
                dataFimInput.readOnly = false;
                dataFimInput.dataset.calculada = '';
                dataFimInput.style.background = '';
                console.log('üîì Data de fim liberada para edi√ß√£o');
            }
        }

        // Executar valida√ß√£o quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üîç Inicializando valida√ß√£o de predecessoras...');
            const predecessorasInputs = document.querySelectorAll('input[name="predecessoras"]');
            console.log(`üìã Encontrados ${predecessorasInputs.length} campos de predecessoras`);
            
            predecessorasInputs.forEach((input, index) => {
                const valor = input.value.trim();
                console.log(`üìù Predecessora ${index + 1}: "${valor}"`);
                if (valor) {
                    console.log(`‚úÖ Executando valida√ß√£o para predecessora: ${valor}`);
                    onPredecessorasEdit(input);
                }
            });
        });
    </script>
</body>
</html> 