{% extends "producao/base.html" %}

{% block producao_title %}Calendário{% endblock %}

{% block producao_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="fas fa-calendar-alt"></i> Calendário de Produção
                </h1>
                <button class="btn btn-producao" onclick="showAddEventModal()">
                    <i class="fas fa-plus me-2"></i>Adicionar Evento
                </button>
            </div>
        </div>
    </div>

    <!-- Controles do Calendário -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-producao">
                <div class="card-header card-header-producao">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar"></i> Controles
                        </h5>
                        <div>
                            <button class="btn btn-outline-light btn-sm" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="mx-3" id="current-month">Janeiro 2024</span>
                            <button class="btn btn-outline-light btn-sm" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="calendar-container">
                        <!-- O calendário será carregado aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Evento -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header card-header-producao">
                <h5 class="modal-title text-white">Adicionar Evento de Produção</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addEventForm">
                    <div class="mb-3">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Coleção</label>
                        <select class="form-control" id="eventColecao" required>
                            <option value="">Selecione uma coleção</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" class="form-control" id="eventQuantidade" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" id="eventObservacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-producao" onclick="saveEvent()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-grid {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.weekday {
    padding: 15px;
    text-align: center;
    font-weight: bold;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.day {
    min-height: 100px;
    padding: 10px;
    border: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.day:hover {
    background-color: #f8f9fa;
}

.day.today {
    background-color: #e3f2fd;
    font-weight: bold;
}

.day.empty {
    background-color: #f8f9fa;
    cursor: default;
}

.day-number {
    font-weight: bold;
    margin-bottom: 5px;
}

.event {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8rem;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>

<script>
let currentDate = new Date();

document.addEventListener('DOMContentLoaded', function() {
    loadCalendar();
    loadColecoes();
});

function loadCalendar() {
    const container = document.getElementById('calendar-container');
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDay = firstDay.getDay();
    
    // Atualizar mês atual
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
    
    let calendarHtml = `
        <div class="calendar-grid">
            <div class="calendar-weekdays">
                <div class="weekday">Dom</div>
                <div class="weekday">Seg</div>
                <div class="weekday">Ter</div>
                <div class="weekday">Qua</div>
                <div class="weekday">Qui</div>
                <div class="weekday">Sex</div>
                <div class="weekday">Sáb</div>
            </div>
            <div class="calendar-days">
    `;
    
    // Adicionar dias vazios no início
    for (let i = 0; i < startingDay; i++) {
        calendarHtml += '<div class="day empty"></div>';
    }
    
    // Adicionar dias do mês
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateString = date.toISOString().split('T')[0];
        const dayEvents = getEventsForDate(dateString);
        const isToday = date.toDateString() === new Date().toDateString();
        
        calendarHtml += `
            <div class="day ${isToday ? 'today' : ''}" onclick="showAddEventModal('${dateString}')">
                <div class="day-number">${day}</div>
                ${dayEvents.map(event => `
                    <div class="event" title="${event.colecao} - ${event.quantidade} unidades">
                        ${event.colecao}
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    calendarHtml += '</div></div>';
    container.innerHTML = calendarHtml;
}

function getEventsForDate(dateString) {
    const eventos = JSON.parse(localStorage.getItem('eventos')) || [];
    return eventos.filter(event => event.data === dateString);
}

function loadColecoes() {
    const colecoes = JSON.parse(localStorage.getItem('colecoes')) || [];
    const select = document.getElementById('eventColecao');
    
    select.innerHTML = '<option value="">Selecione uma coleção</option>';
    colecoes.forEach(colecao => {
        select.innerHTML += `<option value="${colecao.id}">${colecao.nome}</option>`;
    });
}

function showAddEventModal(date = null) {
    if (date) {
        document.getElementById('eventDate').value = date;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
    modal.show();
}

function saveEvent() {
    const date = document.getElementById('eventDate').value;
    const colecaoId = document.getElementById('eventColecao').value;
    const quantidade = document.getElementById('eventQuantidade').value;
    const observacoes = document.getElementById('eventObservacoes').value;
    
    if (!date || !colecaoId || !quantidade) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    const colecoes = JSON.parse(localStorage.getItem('colecoes')) || [];
    const colecao = colecoes.find(c => c.id === colecaoId);
    
    if (!colecao) {
        alert('Coleção não encontrada.');
        return;
    }
    
    const evento = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        data: date,
        colecao_id: colecaoId,
        colecao: colecao.nome,
        quantidade: parseInt(quantidade),
        observacoes: observacoes,
        status: 'PENDENTE',
        created_at: new Date().toISOString()
    };
    
    const eventos = JSON.parse(localStorage.getItem('eventos')) || [];
    eventos.push(evento);
    localStorage.setItem('eventos', JSON.stringify(eventos));
    
    // Fechar modal e recarregar
    const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
    modal.hide();
    
    // Limpar formulário
    document.getElementById('addEventForm').reset();
    
    // Recarregar calendário
    loadCalendar();
    
    alert('Evento salvo com sucesso!');
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    loadCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    loadCalendar();
}
</script>
{% endblock %} 