{% extends "base.html" %}

{% set numero_para_id = {} %}
{% for t in tarefas %}
{% set _ = numero_para_id.update({loop.index|string: t.id}) %}
{% endfor %}

{% set id_para_ordem = {} %}
{% for t in tarefas %}
{% set _ = id_para_ordem.update({t.id: t.ordem|string}) %}
{% endfor %}

{% macro extrair_ids_predecessoras(predecessoras, numero_para_id) -%}
{%- set ids = [] -%}
{%- for pred in predecessoras.split(';') if pred -%}
{%- set num = pred.split('FS')[0].split('SS')[0].split('FF')[0].split('SF')[0] -%}
{%- set id = numero_para_id.get(num, num) -%}
{%- set _ = ids.append(id) -%}
{%- endfor -%}
{{ ids|join(',') }}
{%- endmacro %}

{% block content %}
<div class="container-fluid mt-4" style="padding-left: 15px; padding-right: 0px; padding-bottom: 24px;">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">
                            <i class="fas fa-project-diagram"></i> {{ projeto.nome }}
                        </h2>
                        <!-- Bot√µes removidos do topo -->
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-align-left"></i> Descri√ß√£o:</h5>
                            <p class="text-muted">{{ projeto.descricao or 'Sem descri√ß√£o' }}</p>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-calendar"></i> Per√≠odo do Projeto:</h6>
                                    <p class="mb-1">
                                        <strong>In√≠cio:</strong> {{ projeto.data_inicio }}
                                    </p>
                                    <p class="mb-0">
                                        <strong>T√©rmino:</strong> {{ projeto.data_fim }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <!-- Removido: bloco duplicado de bot√µes acima do t√≠tulo Tarefas do Projeto -->
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-0" style="min-height:44px;">
                        <h5 class="mb-0"><i class="fas fa-tasks"></i> Tarefas do Projeto</h5>
                        <div class="d-flex align-items-center p-0" style="gap: 8px;">
                            {% if pode_editar_projeto %}
                            <a href="{{ url_for('editar_projeto', projeto_id=projeto.id) }}"
                                class="btn btn-warning m-0">
                                <i class="fas fa-edit"></i> Editar Projeto
                            </a>
                            {% endif %}
                            {% if pode_criar_tarefa %}
                            <a href="/tarefas/criar/{{ projeto.id }}" class="btn btn-success m-0">Criar Tarefa</a>
                            {% endif %}
                        </div>
                    </div>
                    {% if tarefas %}
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-hover w-100" id="tabela-tarefas-inline" style="font-size: 0.95em;">
                            <colgroup>
                                <col style="width: 32px;">
                                <col style="width: 40px;">
                                <col style="width: 300px;">
                                <col>
                                <col>
                                <col style="width: 100px;">
                                <col style="width: 100px;">
                                <col style="width: 150px;">
                                <col>
                                <col>
                                <col style="width: 100px;">
                            </colgroup>
                            <thead class="table-dark">
                                <tr>
                                    <th style="width:32px"></th>
                                    <th>N¬∫</th>
                                    <th>Nome</th>
                                    {% if pode_editar_predecessoras %}
                                    <th>Predecessoras</th>
                                    {% endif %}
                                    <th>Data In√≠cio</th>
                                    <th>Data T√©rmino</th>
                                    <th>Dura√ß√£o (dias)</th>
                                    <th>Status</th>
                                    <th>Respons√°vel</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tarefa in tarefas %}
                                <tr {% if tarefa.colecao %}class="linha-colecao" {% endif %}>
                                    <td class="drag-handle"
                                        style="cursor: grab; text-align:center; font-size:1.3em; color:#888;{% if not pode_editar_nome_tarefa %} opacity:0.4; pointer-events:none; cursor:default;{% endif %}">
                                        &#9776;</td>
                                    <td class="numero-tarefa">{{ tarefa.ordem or '' }}</td>
                                    <td><input type="text" class="form-control form-control-sm"
                                            value="{{ tarefa.nome }}" data-id="{{ tarefa.id }}" name="nome" {% if not
                                            pode_editar_nome_tarefa %}disabled{% endif %}></td>
                                    {% if pode_editar_predecessoras %}
                                    <td class="predecessoras-td">
                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-predecessora"
                                            onclick="abrirModalPredecessora(this)"><i class="fas fa-link"></i></button>
                                        <input type="text" class="form-control form-control-sm"
                                            value="{{ tarefa.predecessoras or '' }}" data-id="{{ tarefa.id }}"
                                            name="predecessoras" placeholder="Ex: 2FS+2d"
                                            onchange="onPredecessorasEdit(this)" onkeyup="onPredecessorasEdit(this)">
                                    </td>
                                    {% endif %}
                                    <td><input type="date" class="form-control form-control-sm"
                                            value="{{ tarefa.data_inicio_iso }}" data-id="{{ tarefa.id }}"
                                            name="data_inicio" {% if tarefa.data_inicio_calculada %} data-calculada="1"
                                            readonly style="background:#fffbe6;" {% endif %}
                                            oninput="onInicioOuFimEdit(this)" {% if not pode_editar_data_inicio
                                            %}disabled{% endif %}></td>
                                    <td><input type="date" class="form-control form-control-sm"
                                            value="{{ tarefa.data_fim_iso }}" data-id="{{ tarefa.id }}" name="data_fim"
                                            {% if tarefa.data_fim_calculada %} data-calculada="1" readonly
                                            style="background:#fffbe6;" {% endif %} oninput="onDuracaoOuFimEdit(this)"
                                            onblur="onDuracaoOuFimEdit(this, true)" {% if not pode_editar_data_termino
                                            %}disabled{% endif %}></td>
                                    <td><input type="number" class="form-control form-control-sm" name="duracao" min="1"
                                            value="{{ tarefa.duracao or '' }}" oninput="onDuracaoOuFimEdit(this)"
                                            onblur="onDuracaoOuFimEdit(this, true)" onkeyup="onDuracaoOuFimEdit(this)"
                                            {% if not pode_editar_duracao %}disabled{% endif %}>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" data-id="{{ tarefa.id }}"
                                            name="status">
                                            <option value="pendente" {% if tarefa.status=='pendente' %}selected{% endif
                                                %}>Pendente</option>
                                            <option value="em progresso" {% if tarefa.status=='em progresso'
                                                %}selected{% endif %}>Em Progresso</option>
                                            <option value="conclu√≠da" {% if tarefa.status=='conclu√≠da' %}selected{%
                                                endif %}>Conclu√≠da</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" name="usuario_id"
                                            data-id="{{ tarefa.id }}" {% if not pode_editar_responsavel %}disabled{%
                                            endif %}>
                                            <option value="" {% if not tarefa.usuario_id %}selected{% endif %}>Sem
                                                respons√°vel</option>
                                            {% for usuario in usuarios %}
                                            <option value="{{ usuario.id }}" {% if tarefa.usuario_id==usuario.id
                                                %}selected{% endif %}>{{ usuario.email }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <button class="btn btn-success btn-sm" onclick="salvarLinhaTarefa(this)"><i
                                                class="fas fa-save"></i></button>
                                        {% if pode_editar_tarefa %}
                                        <a href="{{ url_for('editar_tarefa', tarefa_id=tarefa.id) }}"
                                            class="btn btn-warning btn-sm" title="Editar tarefa"><i
                                                class="fas fa-edit"></i></a>
                                        {% endif %}
                                        {% if pode_excluir_tarefa %}
                                        <button class="btn btn-danger btn-sm" onclick="excluirTarefa(this)"><i
                                                class="fas fa-trash"></i></button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                <!-- Linha para nova tarefa -->
                                <tr id="linha-nova-tarefa">
                                    <td></td>
                                    <td></td>
                                    <td><input type="text" class="form-control form-control-sm" name="nome"
                                            placeholder="Nova tarefa" {% if not pode_editar_nome_tarefa %}disabled{%
                                            endif %}></td>
                                    {% if pode_editar_predecessoras %}
                                    <td class="predecessoras-td">
                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-predecessora"
                                            onclick="abrirModalPredecessora(this)"><i class="fas fa-link"></i></button>
                                        <input type="text" class="form-control form-control-sm" name="predecessoras"
                                            value="" placeholder="Ex: 2FS+2d" onchange="onPredecessorasEdit(this)"
                                            onkeyup="onPredecessorasEdit(this)">
                                    </td>
                                    {% endif %}
                                    <td><input type="date" class="form-control form-control-sm" name="data_inicio"
                                            oninput="onInicioOuFimEdit(this)"></td>
                                    <td><input type="date" class="form-control form-control-sm" name="data_fim"
                                            oninput="onDuracaoOuFimEdit(this)" onblur="onDuracaoOuFimEdit(this, true)">
                                    </td>
                                    <td><input type="number" class="form-control form-control-sm" name="duracao" min="1"
                                            placeholder="Dias" oninput="onDuracaoOuFimEdit(this)"
                                            onblur="onDuracaoOuFimEdit(this, true)"></td>
                                    <td>
                                        <select class="form-select form-select-sm" name="status">
                                            <option value="pendente">Pendente</option>
                                            <option value="em progresso">Em Progresso</option>
                                            <option value="conclu√≠da">Conclu√≠da</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" name="usuario_id">
                                            <option value="">Sem respons√°vel</option>
                                            {% for usuario in usuarios %}
                                            <option value="{{ usuario.id }}">{{ usuario.email }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <button class="btn btn-success btn-sm" onclick="criarTarefaNovaLinha(this)"><i
                                                class="fas fa-plus"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h5>Nenhuma tarefa encontrada</h5>
                        <p>Este projeto ainda n√£o possui tarefas. Crie a primeira tarefa para come√ßar!</p>
                    </div>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-end mt-2">
                    <button class="btn btn-primary mb-4" type="button" onclick="salvarTodasTarefas()">
                        <i class="fas fa-save"></i> Salvar todas
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-chart-bar"></i> Gr√°fico de Gantt
                        </div>
                        <div class="card-body">
                            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 0px; gap: 8px;">
                                <button id="zoom-out" class="btn btn-outline-secondary btn-sm" title="Diminuir Zoom"
                                    style="font-size: 1.2em;">-</button>
                                <span id="zoom-label" style="min-width: 40px; text-align: center;">100%</span>
                                <button id="zoom-in" class="btn btn-outline-secondary btn-sm" title="Aumentar Zoom"
                                    style="font-size: 1.2em;">+</button>
                            </div>
                            <div id="gantt-custom" style="width: 100%; overflow-x: auto;">
                                <div style="display: flex; flex-direction: column;">
                                    <div style="display: flex;">
                    </div>
                                </div>
                                <div id="gantt-cronograma-area" style="position: relative;">
                                    <div id="gantt-hoje-container"></div>
                                    <table style="border-collapse: collapse; width: 100%;">
                                        <thead>
                                            <tr>
                                                <th style="width: 320px; min-width: 320px; max-width: 320px; text-align: left; padding: 8px;">
                                                    Tarefa
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="gantt-body">
                                            <!-- Linhas das tarefas geradas via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- Legenda colorida por projeto -->
                            <div class="legend mt-2"
                                style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; align-items: center;">
                                {% for projeto, cor in projects_colors.items() %}
                                <div class="legend-item"
                                    style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #495057; cursor: pointer;"
                                    data-projeto="{{ projeto }}">
                                    <div class="legend-color"
                                        style="width: 16px; height: 16px; border-radius: 3px; background-color: {{ cor }};"></div>
                                    <span>{{ projeto }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="{{ url_for('projetos') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar para a Lista de Projetos
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal avan√ßado de sele√ß√£o de predecessoras -->
<div class="modal fade" id="modalPredecessora" tabindex="-1" aria-labelledby="modalPredecessoraLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPredecessoraLabel">Selecionar Predecessoras</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Tarefa</th>
                            <th>Tipo</th>
                            <th>Deslocamento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tarefa in tarefas %}
                        <tr>
                            <td><input type="checkbox" class="chk-pred" data-id="{{ tarefa.id }}"></td>
                            <td>{{ tarefa.nome }}</td>
                            <td>
                                <select class="form-select form-select-sm tipo-pred" data-id="{{ tarefa.id }}">
                                    <option value="FS">FS</option>
                                    <option value="SS">SS</option>
                                    <option value="FF">FF</option>
                                    <option value="SF">SF</option>
                                </select>
                            </td>
                            <td><input type="text" class="form-control form-control-sm desloc-pred"
                                    data-id="{{ tarefa.id }}" placeholder="Ex: +2d, -1d"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btnSalvarPredecessoras">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos do Gantt Customizado -->
<style>
    /* Estilos do Gantt Customizado */
    .gantt-header {
        display: flex;
        border-bottom: 2px solid #dee2e6;
        background: #f8f9fa;
        font-weight: bold;
    }

    .gantt-header-cell {
        padding: 10px;
        text-align: center;
        border-right: 1px solid #dee2e6;
        min-width: 100px;
        transition: min-width 0.3s ease;
    }

    .gantt-day {
        padding: 10px;
        border-right: 1px solid #dee2e6;
        min-width: 100px;
        text-align: center;
        position: relative;
        transition: min-width 0.3s ease;
    }

    .gantt-row {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        min-height: 40px;
    }

    .gantt-row:nth-child(even) {
        background: #f8f9fa;
    }

    .gantt-task-bar {
        position: absolute;
        height: 20px;
        background: #007bff;
        border-radius: 3px;
        margin-top: 10px;
        cursor: pointer;
        transition: background 0.3s;
        z-index: 10;
        opacity: 1;
    }

    .gantt-task-bar:hover {
        background: #0056b3;
    }

    /* Coluna fixa para Tarefa */
    #gantt-custom th:first-child,
    #gantt-custom td:first-child {
        position: sticky;
        left: 0;
        background: #fff;
        z-index: 50;
        width: 320px;
        min-width: 320px;
        max-width: 320px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .gantt-hoje-linha {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: repeating-linear-gradient(to bottom,
                #e74c3c 0px, #e74c3c 8px,
                transparent 8px, transparent 16px);
        z-index: 5;
        pointer-events: none;
    }

    #gantt-hoje-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    #gantt-cronograma-area {
        position: relative;
    }

    .gantt-row-compact {
        height: 16px !important;
    }

    .gantt-bar-compact {
        height: 18px !important;
        line-height: 18px !important;
        font-size: 11px !important;
        top: 2px !important;
    }

    .gantt-tooltip-detalhado {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px;
        border-radius: 6px;
        font-size: 12px;
        max-width: 300px;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gantt-tooltip-detalhado .gantt-tooltip-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 8px;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 4px;
    }

    .gantt-tooltip-detalhado .gantt-tooltip-info {
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
    }

    .gantt-tooltip-detalhado .gantt-tooltip-label {
        color: #ccc;
        font-size: 11px;
    }

    .gantt-tooltip-detalhado .gantt-tooltip-value {
        color: #fff;
        font-weight: 500;
        text-align: right;
    }

    .gantt-row-compact td,
    .gantt-row-compact th {
        height: 16px !important;
        min-height: 16px !important;
        max-height: 24px !important;
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 13px !important;
    }

    .gantt-h-linha {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 1px;
        background: #dee2e6;
        z-index: 0;
    }

    .gantt-bar-compact.evidencia {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 20;
        opacity: 1 !important;
        border: none !important;
    }

    .gantt-bar-compact.apagada {
        opacity: 0.25 !important;
        filter: grayscale(0.5);
    }

    .legend-item.selecionada {
        outline: 2px solid #222;
        outline-offset: 2px;
        background: #f3f3f3;
        border-radius: 5px;
    }

    #gantt-custom.dragging {
        cursor: grabbing !important;
        user-select: none !important;
    }

    #tabela-tarefas-inline input[name="duracao"] {
        width: 55px !important;
        max-width: 55px !important;
        min-width: 0 !important;
        padding-left: 4px;
        padding-right: 4px;
        text-align: center;
    }

    #tabela-tarefas-inline input[type="date"] {
        width: 110px !important;
        max-width: 110px !important;
        min-width: 0 !important;
        padding-left: 4px;
        padding-right: 4px;
        text-align: center;
    }

    #tabela-tarefas-inline select[name="status"] {
        width: 120px !important;
        max-width: 150px !important;
        min-width: 0 !important;
        padding-left: 4px;
        padding-right: 4px;
        text-align: left;
    }

    #tabela-tarefas-inline td,
    #tabela-tarefas-inline th {
        padding-left: 4px;
        padding-right: 4px;
        padding-top: 10px;
        padding-bottom: 10px;
    }

    #tabela-tarefas-inline input,
    #tabela-tarefas-inline select {
        height: 40px !important;
        line-height: 20px !important;
        vertical-align: middle !important;
    }

    #tabela-tarefas-inline .btn {
        margin: 0px 3px 0px 0px !important;
        padding: 8px 8px !important;
    }

    #tabela-tarefas-inline td:last-child {
        white-space: nowrap;
    }

    #tabela-tarefas-inline input[name="nome"] {
        width: 280px !important;
        max-width: 280px !important;
        min-width: 280px !important;
        padding-left: 4px;
        padding-right: 4px;
    }

    #tabela-tarefas-inline input[name="predecessoras"] {
        width: 120px !important;
        max-width: 180px !important;
        min-width: 60px !important;
        padding-left: 4px;
        padding-right: 4px;
        text-align: center;
    }

    #tabela-tarefas-inline input[type="date"] {
        width: 110px !important;
        max-width: 110px !important;
        min-width: 0 !important;
        padding-left: 6px;
        padding-right: 3px;
        text-align: left;
    }

    #tabela-tarefas-inline select[name="status"] {
        width: 130px !important;
        max-width: 150px !important;
        min-width: 0 !important;
        padding-left: 4px;
        padding-right: 4px;
        text-align: center;
    }

    #tabela-tarefas-inline select[name="usuario_id"] {
        width: 150px !important;
        max-width: 180px !important;
        min-width: 0 !important;
        padding-left: 8px;
        padding-right: 8px;
        text-align: left;
    }

    #tabela-tarefas-inline td.drag-handle {
        width: 25px !important;
        min-width: 25px !important;
        max-width: 32px !important;
        text-align: center;
        vertical-align: middle !important;
        font-size: 1.3em;
        color: #888;
        padding-left: 4px !important;
        padding-right: 0px !important;
    }

    #tabela-tarefas-inline td.numero-tarefa {
        width: 30px !important;
        min-width: 30px !important;
        max-width: 40px !important;
        text-align: center;
        vertical-align: middle !important;
        font-weight: bold;
        padding: 0 !important;
    }

    .linha-colecao {
        background-color: #e0e7ef !important;
    }

    #tabela-tarefas-inline thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #212529 !important;
        color: #fff !important;
    }

    #tabela-tarefas-inline {
        min-width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    #tabela-tarefas-inline select:disabled {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: none !important;
        cursor: not-allowed;
    }
</style>
<script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    window.ganttData = {{ gantt_geral_data | tojson | safe }};
</script>

<script>
    const larguraBase = 4; // 100% = 4px
    let larguraDia = larguraBase;
    const larguraMin = 1;
    const larguraMax = 32;
    const ROW_HEIGHT = 32; // altura de cada linha (ajuste conforme seu CSS)
    const VISIBLE_ROWS = 18; // quantas linhas mostrar de cada vez (ajuste conforme altura do container)
    let tarefas = [];
    let nomesOrdenados = [];
    let grupos = {};
    let periodo = { min: null, max: null };
    let diasTotais = 0;

    // Fun√ß√£o utilit√°ria para agrupar tarefas por nome
    function agruparTarefasPorNome(tarefas) {
        const grupos = {};
        tarefas.forEach(tarefa => {
            if (!grupos[tarefa.name]) grupos[tarefa.name] = [];
            grupos[tarefa.name].push(tarefa);
        });
        return grupos;
    }

    // Fun√ß√£o para obter datas m√≠nimas e m√°ximas
    function obterPeriodo(tarefas) {
        let min = null, max = null;
        tarefas.forEach(t => {
            const ini = new Date(t.start);
            const fim = new Date(t.end);
            if (!min || ini < min) min = ini;
            if (!max || fim > max) max = fim;
        });
        return { min, max };
    }

    // Fun√ß√£o para calcular dias entre datas
    function diasEntre(a, b) {
        return Math.ceil((b - a) / (1000 * 60 * 60 * 24));
    }

    // Fun√ß√£o para cor de status
    function corStatus(tarefa) {
        if (tarefa.bar_color) return tarefa.bar_color;
        if (tarefa.status === 'concluida') return '#28a745';
        if (tarefa.status === 'em-progresso' || tarefa.status === 'em_progresso') return '#17a2b8';
        return '#ffc107';
    }

    // Fun√ß√£o para tooltip
    function tooltipBarra(tarefa) {
        const ini = new Date(tarefa.start).toLocaleDateString('pt-BR');
        const fim = new Date(tarefa.end).toLocaleDateString('pt-BR');
        return `${tarefa.projeto_origem || tarefa.projeto_nome || ''}: ${ini} a ${fim}`;
    }

    function calcularDiasUteis(dataInicio, dataFim) {
        let diasUteis = 0;
        const dataAtual = new Date(dataInicio);
        while (dataAtual <= dataFim) {
            if (dataAtual.getDay() !== 0 && dataAtual.getDay() !== 6) {
                diasUteis++;
            }
            dataAtual.setDate(dataAtual.getDate() + 1);
        }
        return diasUteis;
    }

    function mostrarTooltipDetalhado(event, barra) {
        esconderTooltipDetalhado();
        const startDate = new Date(barra.start);
        const endDate = new Date(barra.end);
        const diasCorridos = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        const diasUteis = calcularDiasUteis(startDate, endDate);
        const diasUteisTexto = diasUteis === 1 ? 'dia' : 'dias';
        const tooltip = document.createElement('div');
        tooltip.className = 'gantt-tooltip-detalhado';
        tooltip.id = 'gantt-tooltip-detalhado';
        const dataInicio = startDate.toLocaleDateString('pt-BR');
        const dataFim = endDate.toLocaleDateString('pt-BR');
        const nomeProjeto = barra.projeto_origem || barra.projeto_nome || 'Projeto n√£o definido';
        tooltip.innerHTML = `
            <div class="gantt-tooltip-title">${barra.name || 'Tarefa sem nome'}</div>
            <div style="color:#ffd700;font-size:11px;margin-bottom:6px;line-height:1.2;">${nomeProjeto}</div>
            <div style="color:#007bff;font-size:11px;margin-bottom:6px;line-height:1.2;"><b>Cole√ß√£o:</b> ${barra.colecao || '-'} </div>
            <div class="gantt-tooltip-info" style="gap: 12px;">
                <span class="gantt-tooltip-label">üèÅ In√≠cio:</span>
                <span class="gantt-tooltip-value">${dataInicio}</span>
                <span class="gantt-tooltip-label">üéØ Fim:</span>
                <span class="gantt-tooltip-value">${dataFim}</span>
            </div>
            <div class="gantt-tooltip-info">
                <span class="gantt-tooltip-label">üìÜ Dias Corridos:</span>
                <span class="gantt-tooltip-value">${diasCorridos} dias</span>
            </div>
            <div class="gantt-tooltip-info">
                <span class="gantt-tooltip-label">üìÜ Dias √öteis:</span>
                <span class="gantt-tooltip-value">${diasUteis} ${diasUteisTexto}</span>
            </div>
        `;
        document.body.appendChild(tooltip);
        atualizarPosicaoTooltipDetalhado(event);
    }

    function esconderTooltipDetalhado() {
        const tooltip = document.getElementById('gantt-tooltip-detalhado');
        if (tooltip) tooltip.remove();
    }

    function atualizarPosicaoTooltipDetalhado(event) {
        const tooltip = document.getElementById('gantt-tooltip-detalhado');
        if (tooltip) {
            const tooltipRect = tooltip.getBoundingClientRect();
            let left = event.clientX + 12;
            let top = event.clientY + 12;
            if (left + tooltipRect.width > window.innerWidth) {
                left = window.innerWidth - tooltipRect.width - 8;
            }
            if (top + tooltipRect.height > window.innerHeight) {
                top = window.innerHeight - tooltipRect.height - 8;
            }
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
    }

    // Fun√ß√£o principal para montar o Gantt (sem virtualiza√ß√£o)
    function montarGanttAgrupado() {
        const dados = window.ganttData || [];
        const body = document.getElementById('gantt-body');
        if (body) body.innerHTML = '<tr><td colspan="2">Carregando...</td></tr>';
        if (!dados.length) {
            if (body) body.innerHTML = '<tr><td colspan="2">Nenhuma tarefa para exibir.</td></tr>';
            return;
        }
        const tarefas = dados.filter(t => !t.type || t.type !== 'project');
        tarefas.sort((a, b) => (a.ordem ?? 0) - (b.ordem ?? 0));
        const grupos = agruparTarefasPorNome(tarefas);
        const nomesOrdenados = Object.keys(grupos).sort((a, b) => {
            const ordemA = Math.min(...grupos[a].map(t => t.ordem ?? 0));
            const ordemB = Math.min(...grupos[b].map(t => t.ordem ?? 0));
            return ordemA - ordemB;
        });
        const periodo = obterPeriodo(tarefas);
        if (!periodo.min || !periodo.max || isNaN(periodo.min) || isNaN(periodo.max)) {
            if (body) body.innerHTML = '<tr><td colspan="2">Per√≠odo inv√°lido para o Gantt.</td></tr>';
            return;
        }
        const diasTotais = Math.max(0, diasEntre(periodo.min, periodo.max));
        // Linha de hoje, cabe√ßalhos, etc (igual ao seu c√≥digo)
        const hojeContainer = document.getElementById('gantt-hoje-container');
        if (hojeContainer) {
            hojeContainer.innerHTML = '';
            hojeContainer.style.position = 'absolute';
            hojeContainer.style.top = '0';
            hojeContainer.style.left = '0';
            hojeContainer.style.bottom = '0';
            hojeContainer.style.right = '0';
            hojeContainer.style.zIndex = '10';
            hojeContainer.style.pointerEvents = 'none';
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            if (hoje >= periodo.min && hoje <= periodo.max) {
                const offset = diasEntre(periodo.min, hoje);
                const left = 320 + (offset * larguraDia); // 320px da coluna tarefa
                const linhaHoje = document.createElement('div');
                linhaHoje.className = 'gantt-hoje-linha';
                linhaHoje.style.left = left + 'px';
                linhaHoje.style.height = '100%';
                hojeContainer.appendChild(linhaHoje);
            }
        }
        // Cabe√ßalho de datas de um n√≠vel (apenas dias)
        const dateHeader = document.getElementById('gantt-date-header');
        if (dateHeader) {
            dateHeader.innerHTML = '';
            // Espa√ßo √† esquerda para alinhar com a coluna Tarefa
            const espacoTarefa = document.createElement('div');
            espacoTarefa.style.width = '320px';
            espacoTarefa.style.minWidth = '320px';
            espacoTarefa.style.maxWidth = '320px';
            espacoTarefa.style.display = 'inline-block';
            espacoTarefa.style.height = '19px';
            espacoTarefa.style.background = 'transparent';
            dateHeader.appendChild(espacoTarefa);
            // N√£o renderizar mais os dias
        }
        // Renderizar todas as linhas de uma vez
        body.innerHTML = '';
        const fragment = document.createDocumentFragment();
        nomesOrdenados.forEach((nome, idx) => {
            const barras = grupos[nome];
            const tr = document.createElement('tr');
            tr.className = 'gantt-row-compact';
            // Nome da tarefa
            const tdNome = document.createElement('td');
            tdNome.textContent = nome;
            tdNome.title = nome;
            tdNome.style.padding = "2px 8px";
            tdNome.style.whiteSpace = "nowrap";
            tdNome.style.overflow = "hidden";
            tdNome.style.textOverflow = "ellipsis";
            tdNome.style.height = "16px";
            tdNome.style.fontSize = "13px";
            tr.appendChild(tdNome);
            // Cronograma
            const tdCrono = document.createElement('td');
            tdCrono.style.position = "relative";
            tdCrono.style.height = "16px";
            tdCrono.style.background = "#f8f9fa";
            tdCrono.style.minWidth = (diasTotais * larguraDia) + "px";
            // Adicionar linha horizontal de grade
            const linhaH = document.createElement('div');
            linhaH.className = 'gantt-h-linha';
            linhaH.style.position = 'absolute';
            linhaH.style.left = '0';
            linhaH.style.right = '0';
            linhaH.style.bottom = '0';
            linhaH.style.height = '1px';
            linhaH.style.background = '#dee2e6';
            linhaH.style.zIndex = '1';
            tdCrono.appendChild(linhaH);
            barras.forEach((barra, idx) => {
                const inicio = new Date(barra.start);
                const fim = new Date(barra.end);
                const offset = diasEntre(periodo.min, inicio);
                const largura = diasEntre(inicio, fim) + 1;
                const div = document.createElement('div');
                div.className = 'gantt-bar-compact';
                div.style.position = "absolute";
                div.style.left = (offset * larguraDia) + "px";
                div.style.top = "2px";
                div.style.height = "8px";
                div.style.width = (largura * larguraDia) + "px";
                div.style.background = corStatus(barra);
                div.style.borderRadius = "4px";
                div.style.textAlign = "center";
                div.style.color = "#fff";
                div.style.fontSize = "11px";
                div.style.lineHeight = "14px";
                div.style.cursor = "pointer";
                div.setAttribute('data-projeto', barra.projeto_origem || barra.projeto_nome || '');
                tdCrono.appendChild(div);
                div.onmouseenter = function (e) {
                    mostrarTooltipDetalhado(e, barra);
                    this._mousemoveHandler = function (ev) {
                        atualizarPosicaoTooltipDetalhado(ev);
                    };
                    this.addEventListener('mousemove', this._mousemoveHandler);
                };
                div.onmouseleave = function () {
                    esconderTooltipDetalhado();
                    if (this._mousemoveHandler) {
                        this.removeEventListener('mousemove', this._mousemoveHandler);
                        this._mousemoveHandler = null;
                    }
                };
            });
            tr.appendChild(tdCrono);
            fragment.appendChild(tr);
        });
        body.appendChild(fragment);
    }

    // Evento de scroll para atualizar as linhas vis√≠veis
    document.addEventListener('DOMContentLoaded', function () {
        montarGanttAgrupado();
        function atualizarZoomLabel() {
            const zoomLabel = document.getElementById('zoom-label');
            if (zoomLabel) {
                const percent = Math.round((larguraDia / larguraBase) * 100);
                zoomLabel.textContent = percent + '%';
            }
        }
        atualizarZoomLabel();
        document.getElementById('zoom-in').onclick = function () {
            if (larguraDia < larguraMax) {
                larguraDia += larguraBase * 0.1;
                if (larguraDia > larguraMax) larguraDia = larguraMax;
                montarGanttAgrupado();
                atualizarZoomLabel();
            }
        };
        document.getElementById('zoom-out').onclick = function () {
            if (larguraDia > larguraMin) {
                larguraDia -= larguraBase * 0.1;
                if (larguraDia < larguraMin) larguraDia = larguraMin;
                montarGanttAgrupado();
                atualizarZoomLabel();
            }
        };

        // Evidenciar barras ao clicar na legenda (agora com sele√ß√£o m√∫ltipla via Ctrl)
        let projetosSelecionados = [];
        document.querySelectorAll('.legend-item').forEach(item => {
            item.addEventListener('click', function (e) {
                const projeto = this.getAttribute('data-projeto');
                if (e.ctrlKey || e.metaKey) {
                    // Sele√ß√£o m√∫ltipla
                    const index = projetosSelecionados.indexOf(projeto);
                    if (index > -1) {
                        projetosSelecionados.splice(index, 1);
                    } else {
                        projetosSelecionados.push(projeto);
                    }
                } else {
                    // Sele√ß√£o √∫nica
                    projetosSelecionados = [projeto];
                }
                if (projetosSelecionados.length === 0) {
                    // Mostrar todas as barras
                    document.querySelectorAll('.gantt-bar-compact').forEach(bar => {
                        bar.classList.remove('evidencia', 'apagada');
                    });
                    document.querySelectorAll('.legend-item').forEach(l => {
                        l.classList.remove('selecionada');
                    });
                } else {
                    document.querySelectorAll('.gantt-bar-compact').forEach(bar => {
                        if (projetosSelecionados.includes(bar.getAttribute('data-projeto'))) {
                            bar.classList.add('evidencia');
                            bar.classList.remove('apagada');
                        } else {
                            bar.classList.remove('evidencia');
                            bar.classList.add('apagada');
                        }
                    });
                    document.querySelectorAll('.legend-item').forEach(l => {
                        const p = l.getAttribute('data-projeto');
                        if (projetosSelecionados.includes(p)) {
                            l.classList.add('selecionada');
                        } else {
                            l.classList.remove('selecionada');
                        }
                    });
                }
            });
        });
    });

    // Sincronizar scroll horizontal do cabe√ßalho e do corpo do Gantt
    const ganttCustom = document.getElementById('gantt-custom');
    const dateHeader = document.getElementById('gantt-date-header');
    const cronogramaArea = document.getElementById('gantt-cronograma-area');
    if (ganttCustom && dateHeader && cronogramaArea) {
        ganttCustom.addEventListener('scroll', function () {
            dateHeader.scrollLeft = ganttCustom.scrollLeft;
            cronogramaArea.scrollLeft = ganttCustom.scrollLeft;
        });
    }

    // Pan/drag horizontal no Gantt
    (function () {
        const ganttCustom = document.getElementById('gantt-custom');
        let isDown = false;
        let startX, scrollLeft;
        if (ganttCustom) {
            ganttCustom.addEventListener('mousedown', function (e) {
                if (e.button !== 0) return; // s√≥ bot√£o esquerdo
                isDown = true;
                ganttCustom.classList.add('dragging');
                startX = e.pageX - ganttCustom.offsetLeft;
                scrollLeft = ganttCustom.scrollLeft;
                document.body.style.cursor = 'grabbing';
                e.preventDefault();
            });
            document.addEventListener('mousemove', function (e) {
                if (!isDown) return;
                const x = e.pageX - ganttCustom.offsetLeft;
                const walk = (x - startX) * -1; // sentido inverso
                ganttCustom.scrollLeft = scrollLeft + walk;
            });
            document.addEventListener('mouseup', function () {
                isDown = false;
                ganttCustom.classList.remove('dragging');
                document.body.style.cursor = '';
            });
            // Evita sele√ß√£o de texto durante o drag
            ganttCustom.addEventListener('mouseleave', function () {
                isDown = false;
                ganttCustom.classList.remove('dragging');
                document.body.style.cursor = '';
            });
        }
    })();

    function marcarDatasVermelhas() {
        document.querySelectorAll('input[type="date"]').forEach(input => {
            const val = input.value;
            if (!val) {
                input.classList.remove('data-vermelha');
                return;
            }
            const [yyyy, mm, dd] = val.split('-');
            if (!yyyy || !mm || !dd) {
                input.classList.remove('data-vermelha');
                return;
            }
            const day = new Date(`${yyyy}-${mm}-${dd}T00:00:00`).getDay();
            const feriado = isFeriado(val);
            // LOG para depura√ß√£o
            console.log('Input:', input, 'Valor:', val, 'Dia da semana:', day, 'Feriado:', feriado);
            if (day === 0 || day === 6 || feriado) {
                input.classList.add('data-vermelha');
            } else {
                input.classList.remove('data-vermelha');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const anoAtual = new Date().getFullYear();
        const uf = 'GO';
        const cidade = 'GOIANIA';
        carregarFeriadosBrasilAPI(anoAtual, uf, cidade);

        // Delega√ß√£o para qualquer input de data, inclusive din√¢mico
        document.body.addEventListener('input', function (e) {
            if (e.target && e.target.type === 'date') {
                setTimeout(marcarDatasVermelhas, 10);
            }
        });
        document.body.addEventListener('change', function (e) {
            if (e.target && e.target.type === 'date') {
                setTimeout(marcarDatasVermelhas, 10);
            }
        });

        // Observa mudan√ßas na tabela para inputs din√¢micos
        const tabela = document.getElementById('tabela-tarefas-inline');
        if (tabela) {
            const observer = new MutationObserver(() => setTimeout(marcarDatasVermelhas, 10));
            observer.observe(tabela, { childList: true, subtree: true });
        }

        // Chama ao carregar
        setTimeout(marcarDatasVermelhas, 10);
    });

    // Fun√ß√µes utilit√°rias para feriados manuais (usadas pelo sistema, sem interface)
    function getFeriadosManuaisStorage(ano) {
        const dados = JSON.parse(localStorage.getItem('feriadosManuais') || '{}');
        return (dados[ano] || []);
    }
    function setFeriadosManuaisStorage(ano, lista) {
        const dados = JSON.parse(localStorage.getItem('feriadosManuais') || '{}');
        dados[ano] = lista;
        localStorage.setItem('feriadosManuais', JSON.stringify(dados));
    }
    // Nova fun√ß√£o: retorna todos os feriados manuais de todos os anos
    function getTodosFeriadosManuais() {
        const dados = JSON.parse(localStorage.getItem('feriadosManuais') || '{}');
        let todos = [];
        Object.values(dados).forEach(arr => { todos = todos.concat(arr); });
        return todos;
    }

    // Nova fun√ß√£o global para evitar erro de refer√™ncia
    function onInicioOuFimEdit(input) {
        setTimeout(() => {
            const tr = input.closest('tr');
            const dataInicio = tr.querySelector('input[name="data_inicio"]').value;
            const dataFim = tr.querySelector('input[name="data_fim"]').value;
            const duracaoInput = tr.querySelector('input[name="duracao"]');
            if (dataInicio && dataFim) {
                const dur = calcularDuracao(dataInicio, dataFim);
                if (duracaoInput) duracaoInput.value = dur;
            }
            marcarDatasVermelhas();
        }, 10);
    }
    window.onInicioOuFimEdit = onInicioOuFimEdit;

    // Debounce para o c√°lculo de dura√ß√£o
    window._debounceTimers = window._debounceTimers || new WeakMap();
    function onDuracaoOuFimEdit(input, immediate) {
        const tr = input.closest('tr');
        if (!immediate) {
            // Debounce: s√≥ executa se o usu√°rio parar de digitar por 400ms
            if (window._debounceTimers.has(tr)) clearTimeout(window._debounceTimers.get(tr));
            const timer = setTimeout(() => {
                _onDuracaoOuFimEditExec(input);
                window._debounceTimers.delete(tr);
            }, 400);
            window._debounceTimers.set(tr, timer);
        } else {
            if (window._debounceTimers.has(tr)) clearTimeout(window._debounceTimers.get(tr));
            _onDuracaoOuFimEditExec(input);
        }
    }
    function _onDuracaoOuFimEditExec(input) {
        const tr = input.closest('tr');
        const dataInicioInput = tr.querySelector('input[name="data_inicio"]');
        const dataFimInput = tr.querySelector('input[name="data_fim"]');
        const duracaoInput = tr.querySelector('input[name="duracao"]');
        const duracao = parseInt(duracaoInput.value, 10);
        const dataInicio = dataInicioInput.value;
        const dataFim = dataFimInput.value;
        if (duracao && duracao > 0) {
            if (dataInicioInput.readOnly && !dataFimInput.readOnly && dataInicio) {
                const inicio = new Date(dataInicio);
                inicio.setDate(inicio.getDate() + duracao - 1);
                dataFimInput.value = inicio.toISOString().split('T')[0];
            }
            else if (dataFimInput.readOnly && !dataInicioInput.readOnly && dataFim) {
                const fim = new Date(dataFim);
                fim.setDate(fim.getDate() - duracao + 1);
                dataInicioInput.value = fim.toISOString().split('T')[0];
            }
            else if (!dataInicioInput.readOnly && !dataFimInput.readOnly) {
                if (dataInicio) {
                    const inicio = new Date(dataInicio);
                    inicio.setDate(inicio.getDate() + duracao - 1);
                    dataFimInput.value = inicio.toISOString().split('T')[0];
                } else if (dataFim) {
                    const fim = new Date(dataFim);
                    fim.setDate(fim.getDate() - duracao + 1);
                    dataInicioInput.value = fim.toISOString().split('T')[0];
                }
            }
        }
        marcarDatasVermelhas();
    }
    window.onDuracaoOuFimEdit = onDuracaoOuFimEdit;

    // Indicativo visual para datas calculadas automaticamente (exemplo: fundo amarelo)
    function marcarDatasCalculadasPorPredecessora() {
        document.querySelectorAll('input[name="data_inicio"], input[name="data_fim"]').forEach(input => {
            if (input.dataset.calculada === '1') {
                input.style.background = '#fffbe6';
            } else {
                input.style.background = '';
            }
        });
    }

    function salvarLinhaTarefa(btn) {
        const tr = btn.closest('tr');
        const tarefaId = tr.querySelector('input[name="nome"]').dataset.id;
        const nome = tr.querySelector('input[name="nome"]').value.trim();
        const predecessoras = tr.querySelector('input[name="predecessoras"]').value.trim();
        const data_inicio = tr.querySelector('input[name="data_inicio"]').value;
        const data_fim = tr.querySelector('input[name="data_fim"]').value;
        const duracao = tr.querySelector('input[name="duracao"]').value;
        const status = tr.querySelector('select[name="status"]').value;
        const usuario_id_el = tr.querySelector('select[name="usuario_id"]');
        let usuario_id = usuario_id_el ? usuario_id_el.value : null;
        usuario_id = (usuario_id === '' ? null : usuario_id);

        if (!nome) {
            alert('O nome da tarefa √© obrigat√≥rio.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        let payload = {
            nome,
            predecessoras,
            data_inicio: data_inicio || null,
            data_fim: data_fim || null,
            duracao: duracao || null,
            status,
            usuario_id: usuario_id || null
        };
        // Se houver input de colecao na linha, envie
        const colecaoInput = tr.querySelector('input[name="colecao"]');
        if (colecaoInput) {
            payload.colecao = colecaoInput.value.trim();
        }
        fetch(`/tarefas/editar/${tarefaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(payload)
        })
            .then(resp => resp.json())
            .then(data => {
                if (data.sucesso) {
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                        btn.disabled = false;
                    }, 1000);
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-danger');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    alert(data.erro || 'Erro ao salvar tarefa.');
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                        btn.disabled = false;
                    }, 2000);
                }
            })
            .catch(() => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                alert('Erro ao salvar tarefa.');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-save"></i>';
                    btn.disabled = false;
                }, 2000);
            });
    }
    window.salvarLinhaTarefa = salvarLinhaTarefa;

    function abrirModalPredecessora(btn) {
        const tr = btn.closest('tr');
        const input = tr.querySelector('input[name="predecessoras"]');
        // Limpa sele√ß√£o
        document.querySelectorAll('.chk-pred').forEach(chk => chk.checked = false);
        document.querySelectorAll('.tipo-pred').forEach(sel => sel.value = 'FS');
        document.querySelectorAll('.desloc-pred').forEach(inp => inp.value = '');
        // Preenche com valores atuais
        const val = input.value.trim();
        if (val) {
            val.split(';').forEach(pred => {
                if (!pred) return;
                // Regex para extrair id, tipo e deslocamento
                const m = pred.match(/^([^FS|SS|FF|SF]+)(FS|SS|FF|SF)?([+-]\d+d)?$/);
                if (m) {
                    const id = m[1];
                    const tipo = m[2] || 'FS';
                    const desloc = m[3] || '';
                    const chk = document.querySelector('.chk-pred[data-id="' + id + '"]');
                    const sel = document.querySelector('.tipo-pred[data-id="' + id + '"]');
                    const inp = document.querySelector('.desloc-pred[data-id="' + id + '"]');
                    if (chk) chk.checked = true;
                    if (sel) sel.value = tipo;
                    if (inp) inp.value = desloc;
                }
            });
        }
        window._inputPredecessorasAtivo = input;
        var modal = new bootstrap.Modal(document.getElementById('modalPredecessora'));
        modal.show();
    }

    document.getElementById('btnSalvarPredecessoras').onclick = function () {
        const preds = [];
        document.querySelectorAll('.chk-pred:checked').forEach(chk => {
            const id = chk.getAttribute('data-id');
            const tipo = document.querySelector('.tipo-pred[data-id="' + id + '"]').value;
            const desloc = document.querySelector('.desloc-pred[data-id="' + id + '"]').value.trim();
            const ordem = window.idParaOrdem[id] || id;
            let pred = ordem + (tipo ? tipo : 'FS') + (desloc ? desloc : '');
            preds.push(pred);
        });
        if (window._inputPredecessorasAtivo) {
            window._inputPredecessorasAtivo.value = preds.join(';');
            window._inputPredecessorasAtivo.dispatchEvent(new Event('change'));
        }
        var modal = bootstrap.Modal.getInstance(document.getElementById('modalPredecessora'));
        modal.hide();
    };

    function calcularDuracao(dataInicio, dataFim) {
        if (!dataInicio || !dataFim) return '';
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        if (isNaN(inicio) || isNaN(fim)) return '';
        // Inclusivo: diferen√ßa em dias + 1
        return Math.floor((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;
    }

    // Salvar ao pressionar Tab ou Enter em qualquer input/select da linha
    function adicionarEventosSalvarTabEnter() {
        document.querySelectorAll('#tabela-tarefas-inline input, #tabela-tarefas-inline select').forEach(el => {
            el.addEventListener('keydown', function (e) {
                const tr = el.closest('tr');
                if (e.key === 'Enter') {
                    if (tr && tr.id === 'linha-nova-tarefa') {
                        // Enter na linha de nova tarefa cria a tarefa
                        const btnCriar = tr.querySelector('.btn-success');
                        if (btnCriar && !btnCriar.disabled) {
                            e.preventDefault();
                            btnCriar.disabled = true; // previne duplo envio
                            criarTarefaNovaLinha(btnCriar);
                            setTimeout(() => { btnCriar.disabled = false; }, 1000); // reabilita ap√≥s 1s
                        }
                    } else if (tr) {
                        // Enter em linha existente salva
                        const btnSalvar = tr.querySelector('.btn-success');
                        if (btnSalvar) {
                            e.preventDefault();
                            salvarLinhaTarefa(btnSalvar);
                        }
                    }
                } else if (e.key === 'Tab') {
                    if (tr && tr.id !== 'linha-nova-tarefa') {
                        const btnSalvar = tr.querySelector('.btn-success');
                        if (btnSalvar) {
                            e.preventDefault();
                            salvarLinhaTarefa(btnSalvar);
                        }
                    }
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', adicionarEventosSalvarTabEnter);
    // Se linhas forem adicionadas dinamicamente, chame adicionarEventosSalvarTabEnter() ap√≥s inserir a linha

    function criarTarefaNovaLinha(btn) {
        const tr = btn.closest('tr');
        const nome = tr.querySelector('input[name="nome"]').value.trim();
        const predecessoras = tr.querySelector('input[name="predecessoras"]').value.trim();
        const data_inicio = tr.querySelector('input[name="data_inicio"]').value;
        const data_fim = tr.querySelector('input[name="data_fim"]').value;
        const duracao = tr.querySelector('input[name="duracao"]').value;
        const status = tr.querySelector('select[name="status"]').value;
        const usuario_id_el = tr.querySelector('select[name="usuario_id"]');
        let usuario_id = usuario_id_el ? usuario_id_el.value : null;
        usuario_id = (usuario_id === '' ? null : usuario_id);

        if (!nome) {
            alert('O nome da tarefa √© obrigat√≥rio.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        // Pega o id do projeto do contexto Jinja
        const projeto_id = '{{ projeto.id }}';

        fetch(`/projetos/${projeto_id}/criar_tarefa_rapida`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                nome,
                predecessoras: predecessoras || null,
                data_inicio: data_inicio || null,
                data_fim: data_fim || null,
                status,
                usuario_id: usuario_id || null,
                duracao: duracao || null
            })
        })
            .then(resp => resp.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i>';
                if (data.sucesso) {
                    // Insere a nova linha antes da linha de nova tarefa
                    const tbody = tr.parentElement;
                    const temp = document.createElement('tbody');
                    temp.innerHTML = data.html_linha;
                    const novaLinha = temp.querySelector('tr');
                    tbody.insertBefore(novaLinha, tr);
                    // Atualiza o n√∫mero da nova linha
                    const linhas = Array.from(tbody.querySelectorAll('tr')).filter(row => row.id !== 'linha-nova-tarefa');
                    const numero = linhas.length;
                    const tdNumero = novaLinha.querySelector('.numero-tarefa');
                    if (tdNumero) tdNumero.textContent = numero;
                    novaLinha.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Limpa os campos da linha de nova tarefa
                    tr.querySelectorAll('input, select').forEach(el => {
                        if (el.tagName === 'SELECT') el.selectedIndex = 0;
                        else el.value = '';
                    });
                    // Reaplica eventos de salvar ao Tab/Enter e drag&drop
                    adicionarEventosSalvarTabEnter();
                    inicializarSortableTarefas();
                    atualizarNumerosTarefas();
                } else {
                    alert('Erro ao criar tarefa: ' + (data.erro || 'Erro desconhecido.'));
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i>';
                alert('Erro ao criar tarefa: ' + err);
            });
    }

    // Fun√ß√£o para excluir tarefa via AJAX
    function excluirTarefa(btn) {
        if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
        const tr = btn.closest('tr');
        const tarefaId = tr.querySelector('input[name="nome"]').dataset.id;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        fetch(`/tarefas/excluir/${tarefaId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(resp => resp.json())
            .then(data => {
                if (data.sucesso) {
                    tr.remove();
                } else {
                    alert(data.erro || 'Erro ao excluir tarefa.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash"></i>';
                }
            })
            .catch(() => {
                alert('Erro ao excluir tarefa.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash"></i>';
            });
    }
    window.excluirTarefa = excluirTarefa;

    // Drag & Drop com SortableJS
    function inicializarSortableTarefas() {
        const tabela = document.getElementById('tabela-tarefas-inline').querySelector('tbody');
        if (!tabela) return;
        new Sortable(tabela, {
            handle: '.drag-handle',
            animation: 150,
            filter: '#linha-nova-tarefa',
            draggable: 'tr:not(#linha-nova-tarefa)',
            onEnd: function () {
                // Atualiza os n√∫meros na coluna "N¬∫"
                const linhas = Array.from(tabela.querySelectorAll('tr')).filter(tr => tr.id !== 'linha-nova-tarefa');
                linhas.forEach((tr, idx) => {
                    const tdNumero = tr.querySelector('.numero-tarefa');
                    if (tdNumero) tdNumero.textContent = idx + 1;
                });
                // Coletar IDs das tarefas na nova ordem
                const ids = linhas.map(tr => tr.querySelector('input[name="nome"]').dataset.id);
                // Enviar para o backend
                fetch('/tarefas/atualizar_ordem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ ids })
                });
            }
        });
    }
    document.addEventListener('DOMContentLoaded', inicializarSortableTarefas);
    // Se linhas forem adicionadas dinamicamente, chame inicializarSortableTarefas() ap√≥s inserir a linha

    function salvarTodasTarefas() {
        // Seleciona todos os bot√µes de salvar das linhas de tarefa (exceto a linha de nova tarefa)
        document.querySelectorAll('#tabela-tarefas-inline tbody tr:not(#linha-nova-tarefa) .btn-success').forEach(btn => {
            salvarLinhaTarefa(btn);
        });
    }
    window.salvarTodasTarefas = salvarTodasTarefas;

    document.addEventListener('DOMContentLoaded', function () {
        const novaLinha = document.getElementById('linha-nova-tarefa');
        if (novaLinha) {
            novaLinha.querySelectorAll('input, select').forEach(el => {
                el.disabled = false;
                el.readOnly = false;
            });
        }
    });

    function liberarLinhaNovaTarefa() {
        const novaLinha = document.getElementById('linha-nova-tarefa');
        if (novaLinha) {
            novaLinha.querySelectorAll('input, select, button').forEach(el => {
                el.disabled = false;
                el.readOnly = false;
                el.style.pointerEvents = 'auto';
            });
            // For√ßa o foco no campo nome ao clicar em qualquer parte da linha
            novaLinha.onclick = function (e) {
                const nomeInput = novaLinha.querySelector('input[name="nome"]');
                if (nomeInput) nomeInput.focus();
            };
        }
    }
    document.addEventListener('DOMContentLoaded', liberarLinhaNovaTarefa);
    // E sempre que criar uma nova tarefa, reaplique:
    const _oldCriarTarefaNovaLinha = criarTarefaNovaLinha;
    criarTarefaNovaLinha = function (btn) {
        _oldCriarTarefaNovaLinha(btn);
        setTimeout(liberarLinhaNovaTarefa, 100);
    }

    function atualizarNumerosTarefas() {
        const linhas = Array.from(document.querySelectorAll('#tabela-tarefas-inline tbody tr')).filter(tr => tr.id !== 'linha-nova-tarefa');
        linhas.forEach((tr, idx) => {
            const tdNumero = tr.querySelector('.numero-tarefa');
            if (tdNumero) tdNumero.textContent = idx + 1;
        });
    }

    function onPredecessorasEdit(input) {
        const tr = input.closest('tr');
        const predecessorasStr = input.value.trim();
        const dataInicioInput = tr.querySelector('input[name="data_inicio"]');
        const dataFimInput = tr.querySelector('input[name="data_fim"]');
        // Se n√£o h√° predecessoras, liberar edi√ß√£o manual
        if (!predecessorasStr) {
            if (dataInicioInput) {
                dataInicioInput.readOnly = false;
                dataInicioInput.dataset.calculada = '';
                dataInicioInput.style.background = '';
            }
            if (dataFimInput) {
                dataFimInput.readOnly = false;
                dataFimInput.dataset.calculada = '';
                dataFimInput.style.background = '';
            }
            return;
        }
        const preds = predecessorasStr.split(';').map(s => s.trim()).filter(Boolean);
        if (preds.length === 0) return;
        // Mapear n√∫mero de ordem para linha da tabela
        const linhas = Array.from(document.querySelectorAll('#tabela-tarefas-inline tbody tr')).filter(tr => tr.id !== 'linha-nova-tarefa');
        const ordemParaLinha = {};
        linhas.forEach(trLinha => {
            const ordem = trLinha.querySelector('.numero-tarefa')?.textContent?.trim();
            if (ordem) ordemParaLinha[ordem] = trLinha;
        });
        // Para cada predecessora, calcular a data alvo
        let datasInicio = [];
        let datasFim = [];
        preds.forEach(pred => {
            // Ex: 2FS+2d, 3SS-1d
            const m = pred.match(/^(\d+)(FS|SS|FF|SF)?([+-]\d+d)?$/);
            if (!m) return;
            const ordemPred = m[1];
            const tipo = m[2] || 'FS';
            const desloc = m[3] || '';
            const linhaPred = ordemParaLinha[ordemPred];
            if (!linhaPred) return;
            const dataInicioPred = linhaPred.querySelector('input[name="data_inicio"]').value;
            const dataFimPred = linhaPred.querySelector('input[name="data_fim"]').value;
            let baseDate = null;
            if (tipo === 'FS') baseDate = dataFimPred;
            else if (tipo === 'SS') baseDate = dataInicioPred;
            else if (tipo === 'FF') baseDate = dataFimPred;
            else if (tipo === 'SF') baseDate = dataInicioPred;
            if (!baseDate) return;
            let data = new Date(baseDate);
            if (desloc) {
                const matchDesloc = desloc.match(/([+-])(\d+)d/);
                if (matchDesloc) {
                    const sinal = matchDesloc[1] === '+' ? 1 : -1;
                    const dias = parseInt(matchDesloc[2], 10);
                    data.setDate(data.getDate() + sinal * dias);
                }
            }
            if (tipo === 'FS' || tipo === 'SS') datasInicio.push(data);
            else if (tipo === 'FF' || tipo === 'SF') datasFim.push(data);
        });
        // Para m√∫ltiplas predecessoras: para datas de in√≠cio, usar a MAIOR; para datas de fim, usar a MAIOR
        let dataInicioFinal = null;
        let dataFimFinal = null;
        datasInicio.forEach(d => { if (!dataInicioFinal || d > dataInicioFinal) dataInicioFinal = d; });
        datasFim.forEach(d => { if (!dataFimFinal || d > dataFimFinal) dataFimFinal = d; });
        // Preencher e bloquear os campos conforme o tipo
        if (dataInicioFinal && dataInicioInput) {
            dataInicioInput.value = dataInicioFinal.toISOString().split('T')[0];
            dataInicioInput.dataset.calculada = '1';
            dataInicioInput.readOnly = true;
            dataInicioInput.style.background = '#fffbe6';
        }
        if (dataFimFinal && dataFimInput) {
            dataFimInput.value = dataFimFinal.toISOString().split('T')[0];
            dataFimInput.dataset.calculada = '1';
            dataFimInput.readOnly = true;
            dataFimInput.style.background = '#fffbe6';
        }
        // Se n√£o houver predecessora para um dos campos, liberar edi√ß√£o
        if (!dataInicioFinal && dataInicioInput) {
            dataInicioInput.readOnly = false;
            dataInicioInput.dataset.calculada = '';
            dataInicioInput.style.background = '';
        }
        if (!dataFimFinal && dataFimInput) {
            dataFimInput.readOnly = false;
            dataFimInput.dataset.calculada = '';
            dataFimInput.style.background = '';
        }
        marcarDatasCalculadasPorPredecessora();
    }
    window.onPredecessorasEdit = onPredecessorasEdit;

    // Garante que datas calculadas por predecessora fiquem com a cor correta ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', function () {
        marcarDatasCalculadasPorPredecessora();
    });
</script>

{% endblock %}